# Настройка транслитерации для MeiliSearch

## Описание

Система автоматически поддерживает поиск на разных раскладках клавиатуры. Теперь если пользователь вводит "DMS" на английской раскладке, система автоматически найдет "ДМС" на русской раскладке, и наоборот.

## Как это работает

1. **Утилита транслитерации** (`goods/utils.py`):
   - Конвертирует символы между русской и английской раскладками
   - Создает все возможные варианты написания для поиска

2. **Обновленный индексер** (`goods/indexers.py`):
   - Добавляет в MeiliSearch поле `transliterated_search`
   - Содержит все варианты написания названий товаров, брендов и групп

3. **Улучшенный поиск** (`goods/views.py`):
   - Автоматически создает варианты запроса с разными раскладками
   - Ищет по всем вариантам и объединяет результаты

## Настройка

### 1. Установка зависимостей

Убедитесь, что MeiliSearch запущен:

```bash
docker-compose up -d meilisearch
```

### 2. Переиндексация товаров

Выполните команду для переиндексации всех товаров с поддержкой транслитерации:

```bash
# Войдите в контейнер Django
docker exec -it django_react_starter_api bash

# Запустите переиндексацию
python manage.py reindex_products --clear
```

### 3. Проверка работы

Откройте интерфейс поиска и попробуйте:

- Ввести "DMS" - должно найти товары с "ДМС"
- Ввести "ДМС" - должно найти товары с "DMS"
- Ввести "RS" - должно найти товары с "РС"

## Примеры использования

### API endpoint для поиска

```bash
GET /api/goods/products/search/?q=DMS
```

Ответ будет содержать:
```json
{
  "results": [...],
  "total": 10,
  "query": "DMS",
  "search_variants": ["DMS", "ДМС"],
  "processing_time": 0
}
```

### Supported mappings

Система поддерживает полную карту русской и английской раскладок:

- `а` ↔ `f`, `б` ↔ `,`, `в` ↔ `d`, `г` ↔ `u`, `д` ↔ `l`
- `е` ↔ `t`, `ж` ↔ `;`, `з` ↔ `p`, `и` ↔ `b`, `й` ↔ `q`
- `к` ↔ `r`, `л` ↔ `k`, `м` ↔ `v`, `н` ↔ `y`, `о` ↔ `j`
- `п` ↔ `g`, `р` ↔ `h`, `с` ↔ `c`, `т` ↔ `n`, `у` ↔ `e`
- `ф` ↔ `a`, `х` ↔ `[`, `ц` ↔ `w`, `ч` ↔ `x`, `ш` ↔ `i`
- `щ` ↔ `o`, `ъ` ↔ `]`, `ы` ↔ `s`, `ь` ↔ `m`, `э` ↔ `'`
- `ю` ↔ `.`, `я` ↔ `z`

## Технические детали

### Структура индекса

MeiliSearch индекс теперь содержит:
- `name` - оригинальное название товара
- `brand_name` - название бренда
- `subgroup_name` - название подгруппы
- `group_name` - название группы
- `transliterated_search` - все варианты транслитерации

### Производительность

- Поиск выполняется по всем вариантам транслитерации
- Дублирующие результаты автоматически исключаются
- Результаты сортируются по релевантности

### Автоматическая переиндексация

Система автоматически переиндексирует товары при:
- Создании/обновлении товара
- Изменении бренда
- Изменении группы или подгруппы
- Изменении менеджера

## Отладка

### Проверка индекса

Откройте MeiliSearch UI: http://localhost:24900

### Логирование

Включите логирование в `settings.py`:

```python
LOGGING = {
    'loggers': {
        'goods': {
            'handlers': ['console'],
            'level': 'INFO',
        },
    },
}
```

### Тестирование транслитерации

```python
from goods.utils import TransliterationUtils

# Тестируем конвертацию
print(TransliterationUtils.ru_to_en("ДМС"))  # "LVC"
print(TransliterationUtils.en_to_ru("DMS"))  # "ВЬС"
print(TransliterationUtils.get_transliterated_variants("DMS"))  # ["DMS", "ВЬС"]
```

## Troubleshooting

### Проблема: Поиск не работает

1. Проверьте, что MeiliSearch запущен
2. Выполните переиндексацию: `python manage.py reindex_products --clear`
3. Проверьте логи Django и MeiliSearch

### Проблема: Неточные результаты

1. Убедитесь, что товары проиндексированы
2. Проверьте поле `transliterated_search` в MeiliSearch UI
3. Обновите индекс: `python manage.py reindex_products`

### Проблема: Медленный поиск

1. Уменьшите количество вариантов в запросе
2. Используйте фильтры для сужения результатов
3. Увеличьте ресурсы MeiliSearch

## Дополнительные возможности

### Расширение карты транслитерации

Для добавления новых символов отредактируйте `RU_TO_EN` в `goods/utils.py`:

```python
RU_TO_EN = {
    # ... существующие mapping
    'ё': '`',  # добавить новый символ
}
```

### Кастомные варианты поиска

Создайте собственную функцию подготовки запроса:

```python
def custom_prepare_query(query):
    # Ваша логика
    return variants
``` 