# Система ролей RUELIQ

Реализована полноценная система ролей с тремя основными ролями пользователей и соответствующими интерфейсами.

## Роли пользователей

### 1. Админ (`admin`)
- **Полный доступ** ко всем функциям системы
- **Может переключаться** между всеми интерфейсами (Админ, Продажи, Продукты)
- **Управление товарами**: создание, редактирование, удаление
- **Управление пользователями**: просмотр, создание, редактирование
- **Доступ ко всем разделам**: товары, пользователи, задачи, приложения, чаты

### 2. Менеджер по продажам (`sales`)
- **Ограниченный доступ** только к интерфейсу продаж
- **Просмотр товаров**: только чтение каталога товаров
- **НЕ может**: создавать, редактировать или удалять товары
- **Доступные разделы**: панель продаж, каталог товаров, клиенты, чаты

### 3. Продукт менеджер (`product`)
- **Доступ** только к интерфейсу управления продуктами
- **Управление товарами**: создание, редактирование, удаление (только своих товаров)
- **Управление категориями**: создание и редактирование групп и подгрупп товаров
- **Доступные разделы**: панель продуктов, управление товарами, задачи, чаты

## Функции системы

### Переключение интерфейсов
- **Админы** могут переключаться между любыми интерфейсами через команды в сайдбаре
- **Другие роли** видят только свой интерфейс
- **Выбор сохраняется** в localStorage для удобства

### Защита на бекенде
- **API разрешения** на основе ролей для всех CRUD операций
- **Менеджеры по продажам** получают ошибку 403 при попытке создания/редактирования товаров
- **Продукт менеджеры** могут редактировать только закрепленные за ними товары

### Условный UI
- **Кнопки создания/редактирования** автоматически скрываются для пользователей без соответствующих прав
- **Динамическая навигация** в зависимости от роли пользователя
- **Защита роутов** с автоматическим перенаправлением

## Технические детали

### Бекенд (Django)
- **Модель пользователя** расширена полем `role` с выбором из 4 вариантов
- **Custom permissions** в `backend/goods/permissions.py`
- **Защищенные ViewSet'ы** для товаров, брендов и категорий
- **Обновленный UserSimpleSerializer** включает роль пользователя

### Фронтенд (React)
- **RoleContext** для управления ролями и переключением интерфейсов
- **usePermissions hook** для проверки разрешений в компонентах
- **RoleGuard компоненты** для защиты роутов
- **Динамические sidebar данные** на основе роли пользователя

## Как добавить нового пользователя с ролью

### Через Django Admin
1. Перейдите в `/admin/`
2. Создайте нового пользователя
3. В поле "Role" выберите нужную роль
4. Сохраните изменения

### Через API
```python
# Создание пользователя с ролью
from user.models import User

user = User.objects.create_user(
    email='manager@example.com',
    password='password123',
    role=User.RoleChoices.SALES_MANAGER
)
```

## Использование на фронтенде

### Проверка разрешений в компонентах
```tsx
import { usePermissions } from '@/contexts/RoleContext'

function ProductActions() {
  const { canCreateProducts, canEditProducts } = usePermissions()
  
  return (
    <div>
      {canCreateProducts() && <Button>Создать товар</Button>}
      {canEditProducts() && <Button>Редактировать</Button>}
    </div>
  )
}
```

### Защита роутов
```tsx
import { AdminGuard, ProductManagerGuard } from '@/components/route-guards/RoleGuard'

function ProtectedRoute() {
  return (
    <AdminGuard>
      <AdminOnlyComponent />
    </AdminGuard>
  )
}
```

### Получение роли пользователя
```tsx
import { useAuth } from '@/stores/authStore'
import { UserRole } from '@/lib/types'

function UserInfo() {
  const { user } = useAuth()
  
  if (user?.role === UserRole.ADMIN) {
    return <div>Вы администратор</div>
  }
  
  return <div>Роль: {user?.role}</div>
}
```

## Безопасность

- **Никогда не полагайтесь только на фронтенд** для ограничения доступа
- **Все операции защищены на уровне API** через custom permissions
- **Роли проверяются на каждом запросе** к защищенным endpoints
- **JWT токены** включают информацию о роли пользователя

## Расширение системы

### Добавление новой роли
1. Обновите `User.RoleChoices` в `backend/user/models.py`
2. Добавьте роль в `UserRole` enum в `frontend/src/lib/types.ts`
3. Обновите permissions в `backend/goods/permissions.py`
4. Добавьте интерфейс в `roleTeams` и `roleNavGroups`
5. Обновите логику в `RoleContext.tsx`

### Добавление новых разрешений
1. Создайте новые методы в `usePermissions` hook
2. Обновите `ProductPermission` или создайте новый permission класс
3. Добавьте проверки в соответствующие ViewSet'ы
4. Обновите UI компоненты для условного отображения 